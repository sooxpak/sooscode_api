<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Mulang Chat & Reaction Test</title>

    <!-- âœ… SockJS & STOMP (ì „ì—­ Stomp ê°ì²´ ë²„ì „) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 16px;
            background: #111827;
            color: #e5e7eb;
        }
        h1 {
            margin-bottom: 4px;
            color: #f97316;
        }
        .card {
            border: 1px solid #374151;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            background: #020617;
        }
        label {
            display: inline-block;
            margin: 4px 0;
        }
        input, textarea, button {
            margin: 4px 0;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #4b5563;
            background: #020617;
            color: #e5e7eb;
        }
        input, textarea {
            width: 100%;
            box-sizing: border-box;
        }
        button {
            cursor: pointer;
            border: none;
            background: #2563eb;
            color: white;
            margin-right: 4px;
        }
        button.secondary {
            background: #6b7280;
        }
        button.danger {
            background: #dc2626;
        }
        #log {
            background: #020617;
            border-radius: 8px;
            border: 1px solid #374151;
            padding: 8px;
            height: 260px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
        }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 11px;
            margin-right: 4px;
            background: #111827;
        }
        .badge.ok {
            background: #16a34a33;
            color: #4ade80;
        }
        .badge.err {
            background: #dc262633;
            color: #fca5a5;
        }
    </style>
</head>
<body>
<h1>Mulang Chat / Reaction Test</h1>
<p style="margin-top:0;font-size:13px;color:#9ca3af">
    ğŸ”‘ <span class="badge ok">ì¿ í‚¤ ê¸°ë°˜ JWT</span> <span class="badge ok">/ws STOMP</span> <span class="badge ok">/api/chat REST</span>
</p>

<div class="card">
    <h3>1. WebSocket ì—°ê²° / êµ¬ë… / ì±„íŒ…</h3>

    <label>Class ID (ìˆ˜ì—… ID, ì˜ˆ: 1)</label>
    <input id="classIdInput" type="number" value="1" />

    <div style="margin:6px 0;">
        <button id="connectBtn">1) ì—°ê²°í•˜ê¸° (/ws)</button>
        <button id="subscribeBtn" class="secondary">2) êµ¬ë… + íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button id="disconnectBtn" class="danger">ì—°ê²° ëŠê¸°</button>
    </div>

    <label>ë³´ë‚¼ ë©”ì„¸ì§€ ë‚´ìš©</label>
    <textarea id="messageInput" rows="2" placeholder="ë³´ë‚¼ ì±„íŒ… ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <button id="sendBtn">3) ì±„íŒ… ì „ì†¡ (/app/chat.send)</button>
</div>

<div class="card">
    <h3>2. ê³µê°(ë¦¬ì•¡ì…˜) í† ê¸€ í…ŒìŠ¤íŠ¸</h3>
    <p style="font-size:12px;color:#9ca3af;margin-top:0;">
        - <b>userIdëŠ” í† í°(JWT)ì—ì„œ ê°€ì ¸ì˜´</b><br/>
        - Bodyì—ëŠ” <code>chatId</code>ë§Œ ë„£ì–´ì„œ <code>POST /api/chat/chat.react</code> í˜¸ì¶œ
    </p>
    <label>Chat ID (ë©”ì‹œì§€ PK, ì˜ˆ: 10)</label>
    <input id="chatIdInput" type="number" />

    <button id="toggleReactionBtn">ê³µê° í† ê¸€ (ì¶”ê°€/ì‚­ì œ)</button>
    <span id="reactionResult" style="margin-left:8px;font-size:13px;color:#fbbf24;"></span>
</div>

<div class="card">
    <h3>3. ë¡œê·¸</h3>
    <div id="log"></div>
</div>

<script>
    let stompClient = null;
    let connected = false;
    let subscription = null;

    const logEl = document.getElementById("log");

    function log(message, type = "info") {
        const time = new Date().toLocaleTimeString();
        let prefix = "";
        if (type === "ok") prefix = "[OK]";
        else if (type === "err") prefix = "[ERR]";
        else if (type === "ws") prefix = "[WS]";
        else if (type === "http") prefix = "[HTTP]";
        else prefix = "[LOG]";

        logEl.textContent += `${time} ${prefix} ${message}\n`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    // 1) WebSocket ì—°ê²°
    document.getElementById("connectBtn").addEventListener("click", () => {
        if (connected) {
            log("ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŒ", "ws");
            return;
        }

        // âœ… ê°™ì€ originì˜ /ws ì—”ë“œí¬ì¸íŠ¸ë¡œ SockJS ì—°ê²° â†’ ë¸Œë¼ìš°ì € ì¿ í‚¤ ìë™ í¬í•¨
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);  // âœ… StompJs.Client ë§ê³  ì´ê±°!

        // ì½˜ì†” ë¡œê·¸ ë„ˆë¬´ ë§ì´ ì°íˆë©´ ë„ê³  ì‹¶ìœ¼ë©´ ì£¼ì„ ì²˜ë¦¬
        stompClient.debug = (str) => log(str, "ws");

        stompClient.connect(
            {}, // í—¤ë” ë¹„ì›€ (ì¿ í‚¤ ê¸°ë°˜ ì¸ì¦)
            (frame) => {
                connected = true;
                log("STOMP ì—°ê²° ì„±ê³µ: " + JSON.stringify(frame.headers), "ok");
            },
            (error) => {
                connected = false;
                log("STOMP ì—°ê²° ì‹¤íŒ¨/ì¢…ë£Œ: " + error, "err");
            }
        );

        log("STOMP connect ì‹œë„...", "ws");
    });

    // 2) êµ¬ë… + íˆìŠ¤í† ë¦¬ ì¡°íšŒ
    document.getElementById("subscribeBtn").addEventListener("click", async () => {
        const classId = document.getElementById("classIdInput").value;
        if (!classId) {
            alert("classIdë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }
        if (!stompClient || !connected) {
            alert("ë¨¼ì € WebSocket ì—°ê²°ì„ í•˜ì„¸ìš”.");
            return;
        }

        // ê¸°ì¡´ êµ¬ë… í•´ì œ
        if (subscription) {
            subscription.unsubscribe();
            subscription = null;
        }

        const destination = `/topic/chat/${classId}`;
        subscription = stompClient.subscribe(destination, (message) => {
            try {
                const body = JSON.parse(message.body);
                log(`[ì±„íŒ… ìˆ˜ì‹ ] ${JSON.stringify(body)}`, "ws");
            } catch (e) {
                log(`[ì±„íŒ… ìˆ˜ì‹ ] ${message.body}`, "ws");
            }
        });

        log(`êµ¬ë… ì™„ë£Œ: ${destination}`, "ok");

        // íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° (REST)
        try {
            const res = await fetch(`/api/chat/history?classId=${encodeURIComponent(classId)}`, {
                method: "GET",
                credentials: "include",  // âœ… ì¿ í‚¤ ê°™ì´ ë³´ëƒ„
                headers: {
                    "Accept": "application/json"
                }
            });

            if (!res.ok) {
                const text = await res.text();
                log(`íˆìŠ¤í† ë¦¬ ìš”ì²­ ì‹¤íŒ¨: ${res.status} ${text}`, "err");
                return;
            }

            const data = await res.json();
            log(`íˆìŠ¤í† ë¦¬ ${data.length}ê°œ ë¶ˆëŸ¬ì˜´`, "http");
            data.forEach((m, idx) => {
                log(`  [${idx + 1}] ${JSON.stringify(m)}`, "http");
            });

        } catch (err) {
            log(`íˆìŠ¤í† ë¦¬ ìš”ì²­ ì¤‘ ì˜¤ë¥˜: ${err}`, "err");
        }
    });

    // 3) ì±„íŒ… ë³´ë‚´ê¸°
    document.getElementById("sendBtn").addEventListener("click", () => {
        const classId = document.getElementById("classIdInput").value;
        const content = document.getElementById("messageInput").value.trim();

        if (!connected || !stompClient) {
            alert("ë¨¼ì € WebSocket ì—°ê²°ì„ í•˜ì„¸ìš”.");
            return;
        }
        if (!classId) {
            alert("classIdë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }
        if (!content) {
            alert("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        const payload = {
            classId: Number(classId),
            content: content
        };

        // âœ… stomp.js 2.x ë°©ì‹: publish ë§ê³  send
        stompClient.send("/app/chat.send", {}, JSON.stringify(payload));

        log(`ë©”ì‹œì§€ ì „ì†¡: ${JSON.stringify(payload)}`, "ws");
        document.getElementById("messageInput").value = "";
    });

    // 4) ì—°ê²° ëŠê¸°
    document.getElementById("disconnectBtn").addEventListener("click", () => {
        if (stompClient && connected) {
            stompClient.disconnect(() => {
                log("STOMP ì—°ê²° ëŠê¹€", "ws");
            });
            connected = false;
        } else {
            log("ì´ë¯¸ ëŠì–´ì ¸ ìˆìŒ", "ws");
        }
    });

    // 5) ê³µê° í† ê¸€ ë²„íŠ¼
    document.getElementById("toggleReactionBtn").addEventListener("click", async () => {
        const chatId = document.getElementById("chatIdInput").value;
        const resultSpan = document.getElementById("reactionResult");
        resultSpan.textContent = "";

        if (!chatId) {
            alert("chatIdë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        try {
            const res = await fetch("/api/chat/chat.react", {   // âœ… ì—”ë“œí¬ì¸íŠ¸ ë°˜ì˜
                method: "POST",
                credentials: "include",   // âœ… ì¿ í‚¤(JWT) ê°™ì´ ë³´ëƒ„
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                body: JSON.stringify({ chatId: Number(chatId) })
            });

            if (!res.ok) {
                const text = await res.text();
                log(`ê³µê° í† ê¸€ ì‹¤íŒ¨: ${res.status} ${text}`, "err");
                resultSpan.textContent = "ì‹¤íŒ¨ (" + res.status + ")";
                return;
            }

            // int ë°˜í™˜ìœ¼ë¡œ ê°€ì •
            const count = await res.json();
            log(`ê³µê° í† ê¸€ ì„±ê³µ, í˜„ì¬ ê³µê° ìˆ˜: ${count}`, "http");
            resultSpan.textContent = `í˜„ì¬ ê³µê° ìˆ˜: ${count}`;

        } catch (err) {
            log(`ê³µê° í† ê¸€ ì¤‘ ì˜¤ë¥˜: ${err}`, "err");
            resultSpan.textContent = "ì˜¤ë¥˜";
        }
    });
</script>
</body>
</html>
